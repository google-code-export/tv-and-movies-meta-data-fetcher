<project name="MediaManager" default="all" basedir="MediaManager-CLI">

    <!-- Path properties -->
    <property name="build.dir" location="${basedir}/bin" />    
    <property name="dist.dir" location="${basedir}/dist" />
    <property name="libs.dir" location="${basedir}/libs" />
    <property name="etc.dir" location="${basedir}/etc" />
    <property name="docs.dir" location="${basedir}/docs"/>
    <property name="api.docs.dir" location="${docs.dir}/api" />
    <property name="userguide.dir" location="${docs.dir}/userguide" />
    <property name="reports.dir" location="${basedir}/reports"/>
    <property name="docbook.home"    value="${basedir}/docbook/xsl"/>
    <property name="fo.dir"          value="${basedir}/fo"/>
    <property name="lib.dir" value="changeme"/>
    <property name="fop.dir" value="changeme"/>

    <!-- Compiler properties -->
    <property name="javac.source" value="1.6" />
    <property name="javac.target" value="1.6" />

    <!-- Dist properties -->
    <property name="project.version" value="changeme" />
    <property name="project.author" value="John-Paul Stanford" />

    <!-- Lib classpaths -->
    <path id="run-time.libs.classpath">
        <pathelement location="${lib.dir}/commons-logging.jar"/>
        <pathelement location="${lib.dir}/commons-cli.jar"/>
    	<pathelement location="${lib.dir}/commons-lang.jar"/>
    	<pathelement location="${lib.dir}/jakarta-commons-exec.jar"/>    	
    	<pathelement location="${lib.dir}/jna.jar"/>
        <pathelement location="${lib.dir}/log4j.jar"/>
    	<pathelement location="${lib.dir}/antlr.jar"/>
    	<pathelement location="${lib.dir}/ROME.jar"/>
    	<pathelement location="${lib.dir}/jdom.jar"/>
    </path>

    <path id="compile-time.libs.classpath">
    	<pathelement location="${lib.dir}/excalibur/avalon-framework.jar"/>
    	<pathelement location="${lib.dir}/xmlgraphics-fop.jar"/>        
    	<pathelement location="${lib.dir}/bnatik-all.jar"/>
    </path>

    <!-- Fop setup -->
    <taskdef name="fop" classname="org.apache.fop.tools.anttasks.Fop">
        <classpath refid="compile-time.libs.classpath"/>
    </taskdef>

    <target name="init">
        <!-- Create the time stamp -->
        <tstamp />
        <!-- Create the build directory structure used by compile -->
        <mkdir dir="${build.dir}" />
        <mkdir dir="${test.build.dir}" />
        <mkdir dir="${dist.dir}" />
        <mkdir dir="${api.docs.dir}" />
        <mkdir dir="${reports.dir}"/>
    </target>
	    
    <target name="clean" description="clean up">
        <!-- Delete the ${build} and ${dist} directory trees -->
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="${build.dir}" includes="**/*"/>
            <fileset dir="${test.build.dir}" includes="**/*"/>
        </delete>
        <delete dir="${dist.dir}" failonerror="false"/>
        <delete dir="${api.docs.dir}" failonerror="false"/>
        <delete dir="${cobertura.dir}" failonerror="false"/>
        <delete dir="${reports.dir}" failonerror="false"/>
        <delete file="cobertura.ser" failonerror="false"/>
        <delete dir="${fo.dir}" failonerror="false"/>
        <delete dir="${basedir}/docbook" failonerror="false"/>
        
        <ant dir="MediaManager-CLI" target="clean"/>
    </target>
    
    <target name="build" description="Build all the subcomponents">
        <ant dir="MediaManager-CLI" target="clean"/>
    </target>

    <target name="jars" description="generate the distribution">
        <echo message="${ant.project.name} ${project.version}" file="${basedir}/VERSION" />

        <jar jarfile="${dist.dir}/${ant.project.name}-${project.version}.jar" basedir="${build.dir}" />
        <copy file="${etc.dir}/defaultConfig.xml" tofile="${dist.dir}/bin/${ant.project.name}-${project.version}/mediamanager-conf.xml"/>
    </target>

    <target name="docs" description="Converts docbook xml into pdf" >
        <delete dir="${docbook.dir}/docbook"/>
        <mkdir dir="${basedir}/docbook"/>
        <mkdir dir="${userguide.dir}/html"/>

        <unzip src="docbook.zip" dest="${basedir}/docbook"/>

        <echo message="DTD: ${docbook.home}/../dtd/docbookx.dtd"/>

        <xmlcatalog id="dtds">                           
            <dtd publicId="-//OASIS//DTD DocBook XML V4.1.2//EN"
                 location="${docbook.home}/../dtd/docbookx.dtd"/>
            <dtd publicId="-//OASIS//DTD DocBook XML V4.2//EN"
                 location="${docbook.home}/../dtd/docbookx.dtd"/>
            <dtd publicId="-//OASIS//DTD DocBook V3.1//EN"
                 location="${docbook.home}/../dtd/docbookx.dtd"/>
        </xmlcatalog>
    	
    	<mkdir dir="${userguide.dir}/xml-updated"/>		
		<copy todir="${userguide.dir}/xml-updated" file="${userguide.dir}/xml/docbook.xml"/>		
		
		<replace file="${userguide.dir}/xml-updated/docbook.xml">
			<replacefilter token="@@version@@" value="${project.version}"/>
			<replacefilter token="@@name@@" value="${ant.project.name}"/>
			<replacefilter token="@@file@@" value="${ant.project.name}-${project.version}-install.jar"/>
			<replacefilter token="@@mode@@" value="0"/>
		</replace>

        <xslt  style="${docbook.home}/fo/docbook.xsl"
                basedir="${userguide.dir}/xml-updated"
                extension=".fo"
                destdir="${fo.dir}">
                <xmlcatalog refid="dtds"/>
        </xslt>

        <xslt  style="${docbook.home}/html/docbook.xsl"
                        basedir="${userguide.dir}/xml-updated"
                        extension=".html"
                        destdir="${userguide.dir}/html">
                <xmlcatalog refid="dtds"/>
        </xslt>

        <fop format="application/pdf"
             fofile="${fo.dir}/docbook.fo"
             outfile="${userguide.dir}/userguide.pdf" />

        <delete dir="${fo.dir}"/>
        <delete dir="${basedir}/docbook"/>
    	<delete dir="${userguide.dir}/xml-updated"/>
    </target>

    <target name="all" depends="clean,build,docs,jars"/>
</project>
